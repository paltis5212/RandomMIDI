# 權重規則

| 名稱 | 說明 |
| - | - |
| pitch | 音高 |
| tempo | 節奏 |
| sentence_num | 句子長度 |
| repeat | 句子重複率（%） ｜
| non_repeat_num | 句子中第幾個音符不重複 |

## 筆記

記一下重複句子算法
取得 句子重複率，便可以算出下個句子多少音符不重複
取得 第幾個音符不重複（最後要符合不重複音符數量喔）
第幾個音符不重複 這個是要換掉的音符的意思，怎麼換呢？

「...前 要換的音符 後...」
利用 前 算出下一個音符，也就是 要換的音符 被替換
利用 替換後的要換的音符 算出下一個音符，也就是 後
後... 整個根據 後 來上下位移
例如原本 後 是 5 4 3
新的 後 為 7，後... 就是 7 6 5，都升了 2
以上為了保持句子平滑
呃，太奇怪了，當備案，這樣重複率不吻合了，後面等於都變了，雖說那種整段升降幾個音的重複方式，也不是沒有...

哎，說實在，目前設定無法對付 整段升降幾個音的重複方式，大概會當全部都是不重複，但他們明明超像？
嘿，所以升降音組合一樣的也當作重複，例如
1 2 4 = +1 +2
5 6 8 = +1 +2
這個也是一種重複，key 就是當段重複數了，本例子為 3
整段升降會出現在哪裡，也要另記呢

多加個規則～如果 重複開頭 在 pos -2，重複數 是 5，這樣實際只有重複到 2 個吧，要怎麼辦？
讓我們把 pos 移到 -5

說回單音不重複問題，如何替換一個音符，又保持句子平滑？
讓我們來分析這種東西吧
「...前 替換音符 後...」
替換音符到後的音階 = 後 - 替換音符
用前取得新的替換音符，替換音符到後，必須在 替換音符到後的音階 範圍內，正負分開好了
如若違背，重新計算
一直違背...那用最接近的
看得懂嗎？就是假設我們平常分析出來這個權重
{+5: 1, +3: 2, -2: 1}

| 替換後音符 | 後 |
| - | - |
| 5 | 9 |

從正數取權重，得 +3
9 - 5 = +4
不在 +3 範圍內，需要重跑
下次

| 替換後音符 | 後 |
| - | - |
| 11 | 9 |

從負數取權重，得 -2
9 - 11 = -2
通過～
有可能跑非常多次，不過 ai 就是這樣啊

那什麼叫都沒結果取最接近，最接近是什麼？
這我懶得多跑，這樣吧，利用權重直接排名，同樣正負分開，所以呢
正 +3: 2 > +5: 1
負 -2: 1
替換音符到後的音階 要在範圍 -2 ~ +3 之中，就這樣

如果還是不行？
天哪...
好吧，取第二順位的權重囉，而且正的要更正，負的更負
正 +5: 1
負 -2: 1
範圍變成 -2 ~ +5
偷偷問你，如果第二順位有這兩個給你選，要選哪個？
{+5: 1, +1: 1}
答案 +5，因為它 > +3，正的更正了

呃，一個很大的問題，到底重複不重複要怎麼弄，小段重複、單音重複、在哪裡重複，要怎麼辦呢？
首先用 重複率 算出要 重複幾個單音。
平常累積個 小段重複率 吧，好，取出它，只會有 要不要小段重複 這樣的結果，每個句子最多一次小段重複，差不多吧？還是我之後弄個，一句子 小段重複幾次 的權重？
又有新任務，哎，所以說 ai 要慢慢寫...
小段重複數加總 = 小段重複幾次 * 小段重複音符數 + ...
重複幾個單音 > 小段重複數加總，才可以執行喔，不然要截掉一些 小段，從後面刪。
來安插小段位置，簡單，先來先挑，利用 小段常出現位置 來挑，然後每個小段間隔一個音符以上。

我猜會有小段安插不進去？
那隨便吧...不放了

等等，只是重複，有必要弄的這麼複雜嗎...？
音樂是偶爾重複，而不是一直重複的呢...
